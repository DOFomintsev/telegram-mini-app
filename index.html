<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Deal</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#000000;
  --card:#111111;
  --glass:rgba(255,255,255,0.05);
}

body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  color:#fff;
  overflow-x:hidden;
  padding-bottom:110px;
}

/* ===== –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è ===== */

.fade-in{
  opacity:0;
  transform:translateY(20px) scale(0.98);
  animation:appear 0.7s cubic-bezier(.2,.8,.2,1) forwards;
}

@keyframes appear{
  to{
    opacity:1;
    transform:translateY(0) scale(1);
  }
}

h1{
  text-align:center;
  padding:24px 0 10px;
  font-size:22px;
  font-weight:700;
}

.categories{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:18px;
  padding:20px;
}

.category-card{
  background:var(--glass);
  backdrop-filter:blur(20px);
  border-radius:24px;
  padding:30px 20px;
  text-align:center;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.08);
}

.prices{
  display:none;
  padding:20px;
}

.price-btn{
  width:100%;
  padding:16px;
  margin-bottom:12px;
  border:none;
  border-radius:16px;
  background:#111;
  color:#fff;
  cursor:pointer;
}

.admin-btn{
  position:fixed;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  background:#222;
  border:none;
  border-radius:16px;
  padding:14px 20px;
  color:#fff;
  cursor:pointer;
}

.admin-item{
  background:#111;
  padding:12px;
  border-radius:12px;
  margin-bottom:12px;
}

.feedback-btn{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#222;
  border:none;
  border-radius:18px;
  padding:16px;
  font-size:15px;
  font-weight:600;
  color:#fff;
  cursor:pointer;
}
</style>
</head>
<body>

<h1 class="fade-in">Smart Deal</h1>

<div class="categories fade-in" id="categories"></div>
<div class="prices fade-in" id="prices"></div>
<div id="adminPanel"></div>

<button class="feedback-btn" onclick="openFeedback()">üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</button>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const ADMIN_ID = 123456789; // ‚Üê –í–°–¢–ê–í–¨ –°–í–û–ô TELEGRAM ID

const user = tg.initDataUnsafe?.user;
const isAdmin = user && user.id === ADMIN_ID;

const SHEET_URL = "https://docs.google.com/spreadsheets/d/1-JYl4b-6H_iWvBS2Zsez1K1DPx35iBUCCPPRiSrVY7o/export?format=csv";

let data = {};

/* ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê MVP ===== */

let stats = JSON.parse(localStorage.getItem("smartDealStats")) || {
  launches: 0,
  users: [],
  categories: {},
  products: {}
};

stats.launches++;

if(user && !stats.users.includes(user.id)){
  stats.users.push(user.id);
}

localStorage.setItem("smartDealStats", JSON.stringify(stats));

/* ===== –ó–∞–≥—Ä—É–∑–∫–∞ Google Sheets ===== */

async function loadData(){

  const response = await fetch(SHEET_URL);
  const text = await response.text();
  const rows = text.split("\n").slice(1);

  rows.forEach(row=>{
    const [category,price,link] = row.split(",");
    if(!data[category]) data[category]=[];
    data[category].push({price,link});
  });

  renderCategories();
}

/* ===== –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ===== */

function renderCategories(){
  const container=document.getElementById("categories");
  container.innerHTML="";
  container.style.display="grid";
  document.getElementById("prices").style.display="none";

  Object.keys(data).forEach(category=>{
    const div=document.createElement("div");
    div.className="category-card";
    div.innerText=category;
    div.onclick=()=>showPrices(category);
    container.appendChild(div);
  });
}

function showPrices(category){

  if(!stats.categories[category]) stats.categories[category]=0;
  stats.categories[category]++;
  localStorage.setItem("smartDealStats", JSON.stringify(stats));

  document.getElementById("categories").style.display="none";
  const pricesDiv=document.getElementById("prices");
  pricesDiv.style.display="block";
  pricesDiv.innerHTML="";

  data[category].forEach(item=>{
    const btn=document.createElement("button");
    btn.className="price-btn";
    btn.innerText=item.price;

    btn.onclick=()=>{
      const key = category + " | " + item.price;
      if(!stats.products[key]) stats.products[key]=0;
      stats.products[key]++;
      localStorage.setItem("smartDealStats", JSON.stringify(stats));
      tg.openLink(item.link);
    };

    pricesDiv.appendChild(btn);
  });

  const back=document.createElement("button");
  back.className="price-btn";
  back.innerText="‚Üê –ù–∞–∑–∞–¥";
  back.onclick=renderCategories;
  pricesDiv.appendChild(back);
}

function openFeedback(){
  tg.openTelegramLink("https://t.me/DFomintsev");
}

/* ===== –ê–¥–º–∏–Ω ===== */

if(isAdmin){
  const btn=document.createElement("button");
  btn.className="admin-btn";
  btn.innerText="‚öô –ê–¥–º–∏–Ω";
  btn.onclick=openAdmin;
  document.body.appendChild(btn);
}

function openAdmin(){
  document.getElementById("categories").style.display="none";
  document.getElementById("prices").style.display="none";

  const panel=document.getElementById("adminPanel");
  panel.style.display="block";
  panel.innerHTML="<h2>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>";

  panel.innerHTML+=`
    <button class="admin-btn" style="position:relative;bottom:auto;margin-bottom:20px;" onclick="openStats()">
      üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    </button>
  `;

  panel.innerHTML+=`<button onclick="exitAdmin()">‚Üê –í—ã–π—Ç–∏</button>`;
}

function openStats(){

  const panel=document.getElementById("adminPanel");
  panel.innerHTML="<h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>";

  panel.innerHTML+=`
    <div class="admin-item"><strong>–ó–∞–ø—É—Å–∫–æ–≤:</strong> ${stats.launches}</div>
    <div class="admin-item"><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong> ${stats.users.length}</div>
  `;

  panel.innerHTML+="<h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>";

  Object.keys(stats.categories)
    .sort((a,b)=>stats.categories[b]-stats.categories[a])
    .forEach(cat=>{
      panel.innerHTML+=`
        <div class="admin-item">${cat}: ${stats.categories[cat]} –∫–ª–∏–∫–æ–≤</div>
      `;
  });

  panel.innerHTML+="<h3>–¢–æ–≤–∞—Ä—ã</h3>";

  Object.keys(stats.products)
    .sort((a,b)=>stats.products[b]-stats.products[a])
    .forEach(prod=>{
      panel.innerHTML+=`
        <div class="admin-item">${prod}: ${stats.products[prod]} –∫–ª–∏–∫–æ–≤</div>
      `;
  });

  panel.innerHTML+=`
    <br>
    <button onclick="resetStats()" style="background:#aa0000;margin-bottom:15px;">
      üóë –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    </button>
    <br>
    <button onclick="openAdmin()">‚Üê –ù–∞–∑–∞–¥</button>
  `;
}

function resetStats(){
  if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?")){
    localStorage.removeItem("smartDealStats");
    location.reload();
  }
}

function exitAdmin(){
  document.getElementById("adminPanel").style.display="none";
  renderCategories();
}

loadData();
</script>
</body>
</html>
