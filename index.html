<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Deal</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#000000;
  --card1:#1DB954;
  --card2:#16a34a;
}

body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  color:#fff;
  overflow-x:hidden;
  padding-bottom:90px;
  position:relative;
}

h1{
  text-align:center;
  padding:24px 0 10px;
  font-size:22px;
  font-weight:700;
}

/* ===== –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ===== */

.categories{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:18px;
  padding:20px;
}

.category-card{
  background:linear-gradient(135deg,var(--card1),var(--card2));
  border-radius:24px;
  padding:30px 20px;
  text-align:center;
  box-shadow:0 12px 35px rgba(29,185,84,0.35);
  cursor:pointer;
}

.label{
  font-size:15px;
  font-weight:600;
}

/* ===== –¶–µ–Ω—ã ===== */

.prices{
  display:none;
  padding:20px;
}

.price-btn{
  width:100%;
  background:#111;
  border:1px solid rgba(255,255,255,.08);
  color:white;
  padding:16px;
  margin-bottom:14px;
  border-radius:16px;
  font-weight:600;
  cursor:pointer;
}

.back-btn{
  text-align:center;
  font-size:14px;
  opacity:.6;
  margin-top:6px;
  cursor:pointer;
}

/* ===== Feedback ===== */

.feedback-btn{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  width:85%;
  max-width:420px;
  background:linear-gradient(135deg,var(--card1),var(--card2));
  border:none;
  border-radius:18px;
  padding:16px;
  font-size:15px;
  font-weight:600;
  color:#fff;
  cursor:pointer;
}

/* ===== Admin ===== */

.admin-btn{
  position:fixed;
  top:18px;
  right:18px;
  background:#111;
  border:1px solid rgba(255,255,255,.15);
  color:#fff;
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  font-size:13px;
  display:none;
}

.admin-panel{
  position:fixed;
  inset:0;
  background:#000;
  padding:25px;
  overflow-y:auto;
  display:none;
  z-index:999;
}

.admin-card{
  background:#111;
  padding:14px;
  border-radius:14px;
  margin-bottom:12px;
  border:1px solid rgba(255,255,255,.08);
}
</style>
</head>

<body>

<h1>Smart Deal</h1>

<div class="categories" id="categories"></div>
<div class="prices" id="prices"></div>

<button class="feedback-btn" onclick="openFeedback()">
üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
</button>

<button id="adminBtn" class="admin-btn">‚öô</button>
<div id="adminPanel" class="admin-panel"></div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const ADMIN_ID = 929524875;

/* ===== SERVER ANALYTICS ===== */

const ANALYTICS_URL = "https://script.google.com/macros/s/AKfycbxcIbUNFvrbt1BMSTPsAt6X7WBf44PXaDoSBu8x5PyqkwndQZVa2w2180AYaYQrRx7y/exec";

function sendAnalytics(data){
  fetch(ANALYTICS_URL,{
    method:"POST",
    body:JSON.stringify(data)
  }).catch(()=>{});
}

/* ===== USER ===== */

const user = tg.initDataUnsafe?.user;
const isAdmin = user && user.id === ADMIN_ID;

if(isAdmin){
  document.getElementById("adminBtn").style.display="block";
}

/* ===== Local Stats (Admin 2.0) ===== */

let stats = JSON.parse(localStorage.getItem("smartDealStats")) || {
  launches:0,
  users:[],
  categories:{},
  products:{}
};

stats.launches++;
if(user && !stats.users.includes(user.id)){
  stats.users.push(user.id);
}

localStorage.setItem("smartDealStats", JSON.stringify(stats));

/* ===== SERVER LOG launch ===== */

sendAnalytics({
  user_id: user?.id || 0,
  username: user?.username || "",
  action: "launch"
});

/* ===== Feedback ===== */

function openFeedback(){
  tg.openTelegramLink("https://t.me/DFomintsev");
}

/* ===== Google Sheets ===== */

const SHEET_URL="https://docs.google.com/spreadsheets/d/1-JYl4b-6H_iWvBS2Zsez1K1DPx35iBUCCPPRiSrVY7o/export?format=csv";
let data={};

async function loadData(){
  const response=await fetch(SHEET_URL);
  const text=await response.text();
  const rows=text.split("\n").slice(1);

  rows.forEach(row=>{
    const [category,price,link]=row.split(",");
    if(!data[category]) data[category]=[];
    data[category].push({price,link});
  });

  renderCategories();
}

/* ===== –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ===== */

function renderCategories(){
  const container=document.getElementById("categories");
  container.innerHTML="";
  container.style.display="grid";

  Object.keys(data).forEach(category=>{
    const div=document.createElement("div");
    div.className="category-card";
    div.innerHTML=`<div class="label">${category}</div>`;

    div.onclick=()=>{
      if(!stats.categories[category]) stats.categories[category]=0;
      stats.categories[category]++;
      localStorage.setItem("smartDealStats", JSON.stringify(stats));

      sendAnalytics({
        user_id: user?.id || 0,
        username: user?.username || "",
        action: "category_click",
        category: category
      });

      showPrices(category);
    };

    container.appendChild(div);
  });
}

/* ===== –¶–µ–Ω—ã ===== */

function showPrices(category){
  const categoriesBlock=document.getElementById("categories");
  const pricesDiv=document.getElementById("prices");

  categoriesBlock.style.display="none";
  pricesDiv.style.display="block";
  pricesDiv.innerHTML="";

  data[category].forEach(item=>{
    const btn=document.createElement("button");
    btn.className="price-btn";
    btn.innerText=item.price;

    btn.onclick=()=>{
      const key=category+" | "+item.price;
      if(!stats.products[key]) stats.products[key]=0;
      stats.products[key]++;
      localStorage.setItem("smartDealStats", JSON.stringify(stats));

      sendAnalytics({
        user_id: user?.id || 0,
        username: user?.username || "",
        action: "product_click",
        category: category,
        product: item.price,
        price: item.price
      });

      tg.openLink(item.link);
    };

    pricesDiv.appendChild(btn);
  });

  const back=document.createElement("div");
  back.className="back-btn";
  back.innerText="‚Üê –ù–∞–∑–∞–¥";
  back.onclick=()=>{
    pricesDiv.style.display="none";
    categoriesBlock.style.display="grid";
    renderCategories();
  };

  pricesDiv.appendChild(back);
}

/* ===== ADMIN PANEL ===== */

document.getElementById("adminBtn").onclick = () => {
  const panel = document.getElementById("adminPanel");
  panel.style.display = "block";

  const totalProductClicks = Object.values(stats.products).reduce((a,b)=>a+b,0);
  const conversion = stats.launches > 0
    ? ((totalProductClicks / stats.launches) * 100).toFixed(1)
    : 0;

  panel.innerHTML = `
    <h2>üìä Smart Deal Analytics</h2>

    <div class="admin-card">üöÄ –ó–∞–ø—É—Å–∫–æ–≤ (local): <b>${stats.launches}</b></div>
    <div class="admin-card">üë§ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö (local): <b>${stats.users.length}</b></div>
    <div class="admin-card">üõí –ö–ª–∏–∫–∏ (local): <b>${totalProductClicks}</b></div>
    <div class="admin-card">üìà –ö–æ–Ω–≤–µ—Ä—Å–∏—è (local): <b>${conversion}%</b></div>

    <br>
    <button onclick="resetStats()">üóë –°–±—Ä–æ—Å–∏—Ç—å local</button>
    <button onclick="closeAdmin()">–ó–∞–∫—Ä—ã—Ç—å</button>
  `;
};

function closeAdmin(){
  document.getElementById("adminPanel").style.display="none";
}

function resetStats(){
  localStorage.removeItem("smartDealStats");
  location.reload();
}

loadData();
</script>

</body>
</html>
