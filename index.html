<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<title>Smart Deal</title>

<style>
:root{
  --bg:#000000;
  --glass:rgba(255,255,255,0.06);
  --glass-border:rgba(255,255,255,0.12);
  --text:#ffffff;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
  text-align:center;
  overflow-x:hidden;
}

/* ===== HEADER ===== */
h1{
  margin:20px 0 10px;
  font-weight:600;
  letter-spacing:1px;
  opacity:0;
  transform:translateY(-20px);
  animation:fadeDown 0.8s ease forwards;
}

@keyframes fadeDown{
  to{opacity:1; transform:translateY(0);}
}

/* ===== CATEGORY GRID ===== */
#categories{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:18px;
  padding:20px;
}

/* ===== GLASS CARD ===== */
.category-card{
  background:var(--glass);
  backdrop-filter:blur(25px);
  border:1px solid var(--glass-border);
  border-radius:22px;
  padding:24px 10px;
  cursor:pointer;
  opacity:0;
  transform:translateY(30px) scale(0.95);
  transition:all .6s cubic-bezier(.2,1.2,.3,1);
}

.category-card.show{
  opacity:1;
  transform:translateY(0) scale(1);
}

.category-card:active{
  transform:scale(0.97);
}

.icon{
  font-size:38px;
  margin-bottom:10px;
  animation:pulse 3s infinite;
}

@keyframes pulse{
  0%{text-shadow:0 0 5px rgba(255,255,255,0.2);}
  50%{text-shadow:0 0 20px rgba(255,255,255,0.6);}
  100%{text-shadow:0 0 5px rgba(255,255,255,0.2);}
}

.label{
  font-size:14px;
  opacity:.85;
}

/* ===== PRICES ===== */
#prices{
  display:none;
  padding:20px;
}

.price-btn{
  width:100%;
  margin:10px 0;
  padding:14px;
  border-radius:16px;
  border:1px solid var(--glass-border);
  background:var(--glass);
  backdrop-filter:blur(15px);
  color:white;
  font-size:16px;
  cursor:pointer;
  opacity:0;
  transform:translateY(20px);
  transition:all .4s ease;
}

.price-btn:active{
  transform:scale(.96);
}

.back-btn{
  margin-top:20px;
  opacity:.6;
  cursor:pointer;
}

/* ===== FEEDBACK BUTTON ===== */
#feedbackBtn{
  position:fixed;
  bottom:15px;
  left:50%;
  transform:translateX(-50%);
  padding:12px 22px;
  border-radius:25px;
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,0.15);
  font-size:14px;
  cursor:pointer;
}

/* ===== ADMIN ===== */
#adminBtn{
  position:fixed;
  top:15px;
  right:15px;
  display:none;
  cursor:pointer;
  opacity:.6;
}

#adminPanel{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:black;
  overflow:auto;
  padding:20px;
}

.admin-card{
  background:var(--glass);
  padding:14px;
  border-radius:14px;
  margin:10px 0;
  border:1px solid var(--glass-border);
}
</style>
</head>

<body>

<h1>Smart Deal</h1>

<div id="adminBtn">‚öôÔ∏è</div>

<div id="categories"></div>
<div id="prices"></div>

<div id="feedbackBtn" onclick="openFeedback()">üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>

<div id="adminPanel"></div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const ADMIN_ID = 123456789; // ‚Üê –í–°–¢–ê–í–¨ –°–í–û–ô ID

const user = tg.initDataUnsafe?.user;
const isAdmin = user && user.id === ADMIN_ID;
if(isAdmin){
  document.getElementById("adminBtn").style.display="block";
}

function haptic(type="light"){
  if(tg.HapticFeedback){
    tg.HapticFeedback.impactOccurred(type);
  }
}

function openFeedback(){
  haptic("medium");
  tg.openTelegramLink("https://t.me/DFomintsev");
}

/* ===== MVP 2.0 STATS ===== */

let stats = JSON.parse(localStorage.getItem("smartDealStats")) || {
  launches:0,
  users:[],
  categories:{},
  products:{},
  visitsByDate:{}
};

const today = new Date().toISOString().split("T")[0];

stats.launches++;
if(user && !stats.users.includes(user.id)){
  stats.users.push(user.id);
}

if(!stats.visitsByDate[today]){
  stats.visitsByDate[today]=0;
}
stats.visitsByDate[today]++;

localStorage.setItem("smartDealStats", JSON.stringify(stats));

/* ===== GOOGLE SHEETS ===== */

const SHEET_URL="https://docs.google.com/spreadsheets/d/1-JYl4b-6H_iWvBS2Zsez1K1DPx35iBUCCPPRiSrVY7o/export?format=csv";
let data={};

async function loadData(){
  const response=await fetch(SHEET_URL);
  const text=await response.text();
  const rows=text.split("\n").slice(1);

  rows.forEach(row=>{
    const [category,price,link]=row.split(",");
    if(!data[category]) data[category]=[];
    data[category].push({price,link});
  });

  renderCategories();
}

/* ===== ICONS ===== */

function getIcon(category){
  const icons={
    "–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã":"üì±",
    "–ù–æ—É—Ç–±—É–∫–∏":"üíª",
    "–ü–ª–∞–Ω—à–µ—Ç—ã":"üßä",
    "–¢–µ–ª–µ–≤–∏–∑–æ—Ä—ã":"üì∫"
  };
  return icons[category] || "‚ú®";
}

/* ===== RENDER ===== */

function renderCategories(){
  const container=document.getElementById("categories");
  container.innerHTML="";
  container.style.display="grid";

  Object.keys(data).forEach((category,index)=>{
    const div=document.createElement("div");
    div.className="category-card";
    div.innerHTML=`
      <div class="icon">${getIcon(category)}</div>
      <div class="label">${category}</div>
    `;

    div.onclick=()=>{
      if(!stats.categories[category]) stats.categories[category]=0;
      stats.categories[category]++;
      localStorage.setItem("smartDealStats", JSON.stringify(stats));
      showPrices(category);
    };

    container.appendChild(div);
    setTimeout(()=>div.classList.add("show"),index*140);
  });
}

function showPrices(category){
  const categoriesBlock=document.getElementById("categories");
  const pricesDiv=document.getElementById("prices");

  haptic("medium");
  categoriesBlock.style.display="none";
  pricesDiv.style.display="block";
  pricesDiv.innerHTML="";

  data[category].forEach((item,index)=>{
    const btn=document.createElement("button");
    btn.className="price-btn";
    btn.innerText=item.price;

    btn.onclick=()=>{
      const key=category+" | "+item.price;
      if(!stats.products[key]) stats.products[key]=0;
      stats.products[key]++;
      localStorage.setItem("smartDealStats", JSON.stringify(stats));
      tg.openLink(item.link);
    };

    pricesDiv.appendChild(btn);
    setTimeout(()=>{
      btn.style.opacity="1";
      btn.style.transform="translateY(0)";
    },index*90);
  });

  const back=document.createElement("div");
  back.className="back-btn";
  back.innerText="‚Üê –ù–∞–∑–∞–¥";
  back.onclick=()=>{
    pricesDiv.style.display="none";
    categoriesBlock.style.display="grid";
    renderCategories();
  };

  pricesDiv.appendChild(back);
}

/* ===== ADMIN PANEL ===== */

document.getElementById("adminBtn").onclick=()=>{
  const panel=document.getElementById("adminPanel");
  panel.style.display="block";

  panel.innerHTML=`
  <h2>üìä Analytics</h2>
  <div class="admin-card">üöÄ –ó–∞–ø—É—Å–∫–æ–≤: ${stats.launches}</div>
  <div class="admin-card">üë§ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${stats.users.length}</div>

  <h3>üìÖ –ü–æ –¥–Ω—è–º</h3>
  ${renderVisits()}

  <h3>ü•á Top-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
  ${renderTop(stats.categories)}

  <h3>üí∞ Top-3 —Ç–æ–≤–∞—Ä—ã</h3>
  ${renderTop(stats.products)}

  <br>
  <button onclick="resetStats()">üóë –°–±—Ä–æ—Å</button>
  <button onclick="closeAdmin()">–ó–∞–∫—Ä—ã—Ç—å</button>
  `;
};

function renderVisits(){
  let html="";
  Object.keys(stats.visitsByDate).sort().forEach(date=>{
    html+=`<div class="admin-card">${date}: ${stats.visitsByDate[date]}</div>`;
  });
  return html || "<div class='admin-card'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>";
}

function renderTop(obj){
  let html="";
  Object.entries(obj)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3)
    .forEach(([key,value],i)=>{
      html+=`<div class="admin-card">${i+1}. ${key} ‚Äî ${value}</div>`;
    });
  return html || "<div class='admin-card'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>";
}

function closeAdmin(){
  document.getElementById("adminPanel").style.display="none";
}

function resetStats(){
  localStorage.removeItem("smartDealStats");
  location.reload();
}

loadData();
</script>

</body>
</html>
