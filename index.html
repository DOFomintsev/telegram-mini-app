<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Deal</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  padding-bottom:100px;
}

h1{
  text-align:center;
  padding:20px 0;
}

.categories{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:15px;
  padding:20px;
}

.category-card{
  background:#1DB954;
  border-radius:20px;
  padding:25px;
  text-align:center;
  cursor:pointer;
}

.prices{
  display:none;
  padding:20px;
}

.price-btn{
  width:100%;
  padding:15px;
  margin-bottom:10px;
  border:none;
  border-radius:12px;
  background:#111;
  color:#fff;
  cursor:pointer;
}

.admin-btn{
  position:fixed;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  background:#444;
  color:#fff;
  padding:12px 20px;
  border:none;
  border-radius:12px;
  cursor:pointer;
}

.feedback-btn{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#1DB954;
  color:#fff;
  padding:15px 20px;
  border:none;
  border-radius:12px;
  cursor:pointer;
}

#adminPanel{
  display:none;
  padding:20px;
}

.admin-item{
  background:#111;
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
}

.admin-item input{
  width:100%;
  margin-bottom:6px;
  padding:6px;
}
</style>
</head>
<body>

<h1>Smart Deal</h1>

<div class="categories" id="categories"></div>
<div class="prices" id="prices"></div>
<div id="adminPanel"></div>

<button class="feedback-btn" onclick="openFeedback()">üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</button>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const ADMIN_ID = 123456789; // ‚Üê –í–°–¢–ê–í–¨ –°–í–û–ô TELEGRAM ID

const user = tg.initDataUnsafe?.user;
const isAdmin = user && user.id === ADMIN_ID;

const SHEET_URL = "https://docs.google.com/spreadsheets/d/1-JYl4b-6H_iWvBS2Zsez1K1DPx35iBUCCPPRiSrVY7o/export?format=csv";

let data = {};

async function loadData(){
  const saved = localStorage.getItem("adminData");
  if(saved){
    data = JSON.parse(saved);
    renderCategories();
    return;
  }

  const response = await fetch(SHEET_URL);
  const text = await response.text();
  const rows = text.split("\n").slice(1);

  rows.forEach(row=>{
    const [category,price,link] = row.split(",");
    if(!data[category]) data[category]=[];
    data[category].push({price,link});
  });

  renderCategories();
}

function renderCategories(){
  const container=document.getElementById("categories");
  container.innerHTML="";
  container.style.display="grid";

  Object.keys(data).forEach(category=>{
    const div=document.createElement("div");
    div.className="category-card";
    div.innerText=category;
    div.onclick=()=>showPrices(category);
    container.appendChild(div);
  });
}

function showPrices(category){
  document.getElementById("categories").style.display="none";
  const pricesDiv=document.getElementById("prices");
  pricesDiv.style.display="block";
  pricesDiv.innerHTML="";

  data[category].forEach((item,index)=>{
    const btn=document.createElement("button");
    btn.className="price-btn";
    btn.innerText=item.price;
    btn.onclick=()=>tg.openLink(item.link);
    pricesDiv.appendChild(btn);
  });

  const back=document.createElement("button");
  back.className="price-btn";
  back.innerText="‚Üê –ù–∞–∑–∞–¥";
  back.onclick=()=>{
    pricesDiv.style.display="none";
    document.getElementById("categories").style.display="grid";
  };

  pricesDiv.appendChild(back);
}

function openFeedback(){
  tg.openTelegramLink("https://t.me/DFomintsev");
}

/* ===================== */
/* ===== ADMIN MVP ===== */
/* ===================== */

if(isAdmin){
  const adminBtn=document.createElement("button");
  adminBtn.className="admin-btn";
  adminBtn.innerText="‚öô –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å";
  adminBtn.onclick=openAdmin;
  document.body.appendChild(adminBtn);
}

function openAdmin(){
  document.getElementById("categories").style.display="none";
  document.getElementById("prices").style.display="none";

  const panel=document.getElementById("adminPanel");
  panel.style.display="block";
  panel.innerHTML="<h2>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>";

  Object.keys(data).forEach(category=>{
    panel.innerHTML+=`<h3>${category}</h3>`;

    data[category].forEach((item,index)=>{
      panel.innerHTML+=`
        <div class="admin-item">
          <input value="${item.price}" onchange="updatePrice('${category}',${index},this.value)">
          <input value="${item.link}" onchange="updateLink('${category}',${index},this.value)">
          <button onclick="deleteItem('${category}',${index})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
    });

    panel.innerHTML+=`
      <button onclick="addItem('${category}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    `;
  });

  panel.innerHTML+=`
    <br><button onclick="saveAdmin()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="location.reload()">‚Üê –í—ã–π—Ç–∏</button>
  `;
}

function updatePrice(cat,i,val){
  data[cat][i].price=val;
}
function updateLink(cat,i,val){
  data[cat][i].link=val;
}
function deleteItem(cat,i){
  data[cat].splice(i,1);
  openAdmin();
}
function addItem(cat){
  data[cat].push({price:"–ù–æ–≤–∞—è —Ü–µ–Ω–∞",link:"https://"});
  openAdmin();
}
function saveAdmin(){
  localStorage.setItem("adminData",JSON.stringify(data));
  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ");
}

loadData();
</script>
</body>
</html>
